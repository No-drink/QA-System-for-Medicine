# 医药问答系统实验报告

## 功能描述

通过对药标网（[中国药典、兽药典质量标准在线查询-药标网 (yaobw.cn)](http://yaobw.cn/)）中《中国药典2015年版》进行爬取，搜集，整理，并编写一套相应的QA系统，来回答相关的药材使用问题，如“清热解毒（疗效）的药材有哪些？”“ 需要放置在xxx(存放条件）下的药材有哪些？”“xxx（药材名）的【】（条目名）是什么？”“ xxx有不宜同用的药吗？”四类型问题。

## 关键步骤

+ 数据爬取
+ 建立倒排索引
+ Mongo数据库的建立
+ 数据分析处理
+ 分析问题与答案生成
+ QA系统

## 步骤分述

1. 数据爬取

+ 对于药标网的数据爬取通过Selenium自动化工具进行，通过对于药标网网页源代码的观察，可得到其“查看”按钮与“下一页”按钮的XPath代码具有明显的规律性，通过XPath定位方式，逐个点击“查看”按钮进入相应页面，定位其具体内容并存储，每页进行20次循环，共遍历284页即可获取全部数据。这里需要注意的是该网站有个别查看按钮已失效，故在循环中应注意捕获相应的“未找到相应对象”异常，避免出现程序报错的情况，保证程序的鲁棒性。

<img src="C:\Users\Joey\AppData\Roaming\Typora\typora-user-images\image-20220604230650003.png" alt="image-20220604230650003" style="zoom: 50%;" />

<img src="C:\Users\Joey\AppData\Roaming\Typora\typora-user-images\image-20220605005234989.png" alt="image-20220605005234989" style="zoom:50%;" />

+ 爬取数据的存储方式我们在初期采取了多种格式，以保证在后续的索引建立等环节有多种方式可以选择。分别是：

>+ 全部信息都逐条存储在一个.txt文件中；
>+ 每个药品的信息都分别存储在一条.txt文件中，文件名命名为药品名，同时建立一个索引文件存放各个药品名称，便于后期对各文件进行遍历时使用；
>+ 先将全部药品信息存放在一个大型字典中，最后通过json.dump（）方法存储为一个.json文件，方便后续读取为一个字典。

2. 建立倒排索引

+ 建立倒排索引的重点在于对结果进行分词，分词结束后再将出现过相关分词的文件记录于相应表项中。在这里我们采用了Python的jieba.lcut_for_search（）方法进行分词，当分词结果以list形式传回后，可以用set（）方法转化为集合以达到去重复的目的，再将“，”“\n”“。”“—”“本品”“的”等无意义的标点词语删除，最后通过遍历文件即可得到相应的倒排索引。
+ 对于倒排索引的存储我们采用了字典的形式，使用json.dump（）方法存为.json文件。可以看出倒排索引的文件大小远超过原先爬取的数据大小，达到了128M大小。

3. Mongo数据的建立

+ 考虑到读取的json文件较大和使用字典进行搜索效率较低的问题，我们引进了Mongo数据库用以存放相应的词条信息。由于Mongo数据库操作简单，也属于较为流行的非关系型数据库，因此只需要将之前获取得到的信息的每个词条进行分割，之后存为相应的字典项，并在每项中加入“药名”这一项，便可使用pymongo.insert_many（）方法，将所有信息存入数据库中。
+ 对于信息的分割，由于每个词条标题都有明显的“【】”作为标记，我们采用了正则表达式的方法进行分割，通过Python自带的re库，对“【】”和“】【”进行非贪婪匹配，即可获得每个条目所对应的内容，之后存为字典即可。

4. 数据分析处理

+ 为了方便确定问题的类型，我们将所有爬取到的信息进行了分词以及分类，以便在后续问答过程中匹配关键字。每个分类结果都是该种类型提问中可能会出现的所有词条的集合（但以列表形式存放），例如疗效的集合“liaoxiao_key”中会存放有“清热解毒”“化痰止咳”等功效词条，当后续在问题中匹配到相应的词条时，便可确定该问题属于疗效分类下的问题。以下是具体的各个分类：

  > + 药材名词库（yaocai_key）：存放了所有药材名的词条，使用之前生成的索引文件即可生成。
  > + 【】内条目名词库（list_key）：存放了爬取到的信息中，位于“【】”中的条目的词条，通过对上一步骤中的正则表达式的匹配结果进行存储即可得到。
  > + 存放名词库（cunfang_key）：存放了所有存放条件的相应词条，通过使用MongoDB的检索功能，检索每个药材的存放条目，再利用jieba库进行分词，去重即可得到。但结果效果不佳，便对结果进行了人工筛选。
  > + 疗效名词库（liaoxiao_key）：存放了所有药物具有的各种疗效，生成方式同上，但结果不需要人工筛选。
  > + 不宜同用药字典（buyi_dic）：用于搜索不宜用药物的字典。通过MongoDB对“注意”条目进行搜索，对结果筛选和分词便可得到。键值为药品名与其不宜共用的药物。

5. 分析问题与答案生成

+ 上述步骤均为信息的获取及处理，从本步骤开始则开始进行QA系统的搭建。对于分析问题和答案生成，我们通过封装了两个类：Question及Answer类，来实现对于问题的分析及生成相应的答案。

+ Question类

  > + 属性包括raw_question（输入的问题原句），fenci_question（对原句进行初步分词后的结果），question_type（问题类型），final_question （处理后的纯问题关键字）。同时将第4步中的条目也作为属性进行了存储。
  >
  > + 方法包括fenci（），find_type（），find_other_key（）：
  >
  >   > + fenci（）：对输入的问题原句进行分词,得出fenci_question。通过jieba库即可完成相应功能，最后修改该对象的fenci_question属性。
  >   > + find_type（）：明确问题的类型，并获取部分关键字。通过遍历判断fenci_question中的内容是否在步骤4中得到的名词库中，如果存在，则将其question_type赋值为相应类型，同时将该分词存放在final_question属性中。若不存在，则赋值为‘unknow’。
  >   > + find_other_key()：寻找全部的问题关键字。如果find_type（）方法判断该问题是查询药品的相应条目或者是不宜共用药的话，此时问题关键字还应当包括药品名，故通过该方法匹配到相应的药品名，并append到final_question之后。此时便可得到全部的问题关键字。

+ Answer类

  > + 属性包括question，question_type，raw_answer和final_answer以及buyi_dic和reuslt。其中question，question_type分别对应Question类中的final_question和question_type，通过初始函数传入，raw_answer和final_answer是初步得到的结果关键字和对语言进行优化后的最终结果。buyi_dic和reuslt则存放前述步骤得到的不宜同用药字典和倒排索引。
  >
  > + 方法包括find_answer（），give_answer（）：
  >
  >   > + find_answer（）：根据类型和关键字从MongoDB，倒排索引，或是不宜同用药字典中搜索答案，如果是疗效类问题，存放类问题，从倒排索引中搜索；如果是不宜同用药问题，从不宜同用药字典中搜索；如果是某药品具体条目问题，则从数据库中搜索。并将搜索结果传回raw_answer。
  >   >
  >   > + give_answer（）：根据不同问题种类组织语言，并将最后结果传回final_answer。

6. QA系统

+ QA系统的建立较为容易，只需要读取整理好的词库，以及在初始化Question和Answer类时将相关参数传入对象，调用封装好的函数，读取问题并输出解答即可。

## 结果展示

+ 疗效类问题：

![image-20220605020602280](C:\Users\Joey\AppData\Roaming\Typora\typora-user-images\image-20220605020602280.png)

+ 存放类问题：

![image-20220605020821196](C:\Users\Joey\AppData\Roaming\Typora\typora-user-images\image-20220605020821196.png)

+ 条目类问题：

![image-20220605020922885](C:\Users\Joey\AppData\Roaming\Typora\typora-user-images\image-20220605020922885.png)

+ 不宜同用药问题：

![image-20220605021012105](C:\Users\Joey\AppData\Roaming\Typora\typora-user-images\image-20220605021012105.png)

![image-20220605021720783](C:\Users\Joey\AppData\Roaming\Typora\typora-user-images\image-20220605021720783.png)